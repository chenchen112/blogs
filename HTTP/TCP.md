# TCP 连接

传输控制协议（TCP，Transmission Control Protocol）是一种面向连接的、可靠的、基于字节流的传输层通信协议。所谓面向连接，是指通信双方在进行通信之前，事先在双方之间建立起一个完整的、可以彼此沟通的通道，这个通道就是连接。

TCP是基于连接的协议，也就是说，在正式收发数据之前，必须和对方建立可靠的连接。一个TCP连接的建立要经过三次握手，释放连接一般需要四次挥手

## 三次握手

<div style="text-align:center"><img src="@/TCPConnect.png"/></div>

在握手之前，主动打开连接的客户端结束 CLOSE 阶段，被动打开的服务器也结束 CLOSE 阶段，并进入 LISTEN 阶段。随后进入三次握手阶段

- **第一次握手**：建立连接时，客户端发送 SYN 包到服务器，并进入 SYN_SEND 状态，等待服务器确认。标志位为 SYN，表示请求建立连接，序号为 Seq = x（x一般为1），随后客户端进入 SYN-SENT 阶段

- **第二次握手**：服务器收到 SYN 包，对该包进行确认后结束 LISTEN 阶段 ，同时自己也发送一个 SYN+ACK 包，表示确认客户端的报文 Seq 序号有效，服务器能正常接收客户端发送的数据，并同意创建新连接，此时服务器进入 SYN_RECV 状态。这个报文同样不携带数据

- **第三次握手**：客户端收到服务器的 SYN + ACK 包，明确了从客户端到服务器的数据传输是正常的，向服务器发送确认包 ACK，此包发送完毕，客户端和服务器进入 ESTABLISHE 态。 此时，TCP 连接已经建立。


三次握手就好像是两个人打电话之前的准备阶段：

- 第一步，打电话的人A先拨打对方B的电话号码（发送SYN）。
- 第二步，对方B接到电话后告诉A自己也准备好了（发送SYN和ACK）。
- 第三步，A再回复一句“知道了”（发送ACK），这样通话就建立起来了。


> 为什么是「三」次握手？  
> 
> 因为三次是保证client和server端均让对方知道自己具备发送和接收能力的最小次数：
> - client > server：client具备发送能力
> - server > client：server具备接收和发送能力
> - client > server：client具备接收能力

### 四次挥手

<div style="text-align:center"><img src="@/TCPDisconnect.png"/></div>

在结束之前，通信双方都是处于 ESTABLISHED 状态，然后其中一方主动断开连接。
下面假如客户端先主动断开连接

- **第一次挥手**：客户端向服务器发送 FIN 报文，表示请求释放连接，然后进入 FIN_WAIT_1 状态。此报文段 FIN = 1， Sequence Number = u，随后客户端进入FIN-WAIT-1阶段，即半关闭阶段，并且停止向服务端发送通信数据

- **第二次挥手**：服务端收到客户端的 FIN 报文，然后发送确认报文段，进入 CLOSE_WAIT 状态。此报文段 ACK = 1， Sequence Number = u + 1。客户端收到该报文，会进入 FIN_WAIT_2 状态

- **第三次挥手**：同时服务端向客户端发送结束报文段，然后进入 LAST_ACK 状态。此报文段 FIN = 1，Sequence Number = w

- **第四次挥手**：客户端收到服务端的结束报文段，然后发送确认报文段，进入 TIME_WAIT 状态，经过 2MSL(等待两倍的最大报文段生存时间) 之后，自动进入 CLOSED 状态。此报文段 ACK = 1, Sequence Number = u + 1


服务端收到该报文之后，进入 CLOSED 状态

四次挥手则好比是结束通话时的步骤：

- A说“我没什么要说了，准备挂断电话”（发送FIN）。
- B说“好的，我知道了”（发送ACK）。
- B说“我也没什么要说了，我要挂断电话”（发送FIN）。
- A说“知道了，再见”（发送ACK），然后挂断电话。

> 为什么是「四」次挥手？  
> 因为TCP是一个全双工协议，必须单独拆除每一条信道，两个方向的接收、发送都需要单独关闭。


> 全双工协议：指允许数据在通信设备之间双向传输的协议。在全双工通信中，通信设备可以同时发送和接收数据，而不需要切换发送和接收模式

### 说明

- SYN：请求建立连接
- FIN：请求释放连接
- Seq：用来标识数据流中的每个字节的序号。发送方在发送数据时，会给每个数据包中的字节编号，接收方在接收数据时，根据Seq来确定数据的顺序和完整性
- ACK：当一端的计算机接收到另一端发送的数据包时，会通过发送 ACK 来告知对方已经成功接收到数据。这样可以确保数据的可靠传输，因为发送方可以根据收到的 ACK 确认信息来知道哪些数据已经成功传输，哪些数据需要重新发送。ACK也可以用来实现流量控制和拥塞控制，从而更有效地管理网络传输。

### 总结

TCP 的整个交流过程可以总结为：先建立连接，然后传输数据，最后释放链接。